:imagesdir: ../../assets/images
include::../style.adoc[]


== Kafka Basics - Consumer Groups and Rebalancing
Kafka Consumer Groups are designed for scalable and highly available message consumption from Kafka topics. Each consumer belongs to a consumer group, a list of consumer instances that ensures fault tolerance and scalable message processing. When a consumer group contains only one consumer, that consumer is responsible for processing all messages of all partitions. 

When multiple consumers join the same group and subscribe to a topic, Kafka distributes the topic's partitions among them, ensuring that each partition is consumed by only one member of that group. This enables horizontal scaling of message processing; by adding more consumers to a group, the workload can be efficiently spread across them, allowing applications to handle high data volumes

*If you add more consumers to a consumer group than the number of partitions for a topic, the extra consumers stay idle without receiving any messages.*

The dynamic assignment of partitions to consumers within a group is managed through a process called *rebalancing*. Rebalances occur when a consumer joins or leaves a group, crashes, or when a subscribed topic's partitions are modified, ensuring that partitions are quickly reassigned among active members
Let's see how this works in practice

* Again, run a producer that generates messages with key-value pairs in the *upper terminal*. 
+
[source,sh,role="execute",subs=attributes+]
----
oc run -n kafka-{user_name} load-producer --rm -it --restart=Never \
  --image=registry.redhat.io/amq-streams/kafka-40-rhel9:3.0.0 -- \
  bash -lc 'i=1; while true; do echo "k$((i%10)):msg-$i"; i=$((i+1)); sleep 0.3; done | \
  /opt/kafka/bin/kafka-console-producer.sh \
    --bootstrap-server kafka-kafka-bootstrap:9092 \
    --topic demo \
    --property parse.key=true \
    --property key.separator=:'
----

* Now let's start three consumers in the same consumer group demo-cg in one by one using a simple bash script. As you proceed through the script and keep starting new consumers, you will see the rebalancing of partitions between the consumers. 

* In the *lower terminal*, make sure you are on the `kafka-{user_name}` project.
+
[source,bash,role="execute",subs=attributes+]
----
oc project kafka-{user_name}
----


* First run the following command to start the first consumer in the *lower terminal*. *Do not press enter when it prompts to start the second consumer yet.* 
+
[source,bash,role="execute",subs=attributes+]
----
curl -s https://raw.githubusercontent.com/streams-kafka-workshop/workshop_scripts/refs/heads/main/demo-cg_consumers.sh | bash
----

* Navigate to the https://amq-streams-console-{user_name}.{openshift_cluster_subdomain}/kafka[streams console, window="console"] > consumer groups > demo-cg to view the first consumers and partitions being assigned to each consumer. 
+
image::m1/demo-cg.png[]

* Since there is currently only one consumer (cg-c1), it will be assigned all the partitions of the topic `demo`. All messages sent to all the partitions will be consumed by this single consumer (cg-c1).
+
image::m1/demo-cg-c1.png[]




* After verifying that all the partitions are assigned to cg-c1, press enter to start the second consumer (cg-c2) in the **lower terminal**. *Do not press enter to start the third consumer yet.*

* Go back to the https://amq-streams-console-{user_name}.{openshift_cluster_subdomain}/kafka[streams console, window="console"] and observe the partitions being assigned to cg-c1 and cg-c2.  You will see a rebalance happening and partitions getting reassigned between cg-c1 and cg-c2 as shown below. 


* You should see that one consumer is responsible for one partition and the other consumer is responsible for the other two partitions.
+
image::m1/demo-cg-c1-c2.png[]

* Press enter on the *lower terminal* to start the third consumer (cg-c3). You will see another rebalance happening and partitions getting reassigned between cg-c1, cg-c2 and cg-c3. *Do not press enter to start the fourth consumer yet.*

* Go back to the https://amq-streams-console-{user_name}.{openshift_cluster_subdomain}/kafka[streams console, window="console"] and observe the partitions being assigned to cg-c1, cg-c2 and cg-c3.
+
image::m1/demo-cg-c1-c2-c3.png[]


* If you start a 4th consumer in the same group, it will sit idle (no partition left), which is expected. In this case, we have 3 partitions and 3 consumers. Since there are no more partitions left, the 4th consumer will not be assigned any partitions and will remain idle. This is because Kafka ensures that each partition is consumed by only one member of a consumer group at any given time to avoid duplicate processing of messages. 

* Go ahead and start the 4th consumer by pressing enter in the *lower terminal*. You will see that the 4th consumer (cg-c4) is started but it is not assigned any partitions and remains idle as shown below. *Do not press enter again to stop the other consumers yet.*
+
image::m1/demo-cg-c1-c2-c3-c4.png[]

* If we stop all the consumers except the first one (cg-c1), all the partitions will be reassigned to cg-c1 automatically. Go ahead and stop the consumers cg-c2, cg-c3 and cg-c4 by pressing enter You will see rebalancing happening and all the partitions getting reassigned to cg-c1 automatically. *Do not hit enter stop the first consumer (cg-c1) yet as we will need it in the next section.*
+
image::m1/demo-cd-c1-only.png[]
 


=== Offsets and Lag
Offsets in Kafka are unique, continually increasing integer identifiers assigned to each message within a partition, acting as a bookmark for consumers to track their processing progress. 

Lag, or consumer lag, is a crucial metric that quantifies how far behind a consumer or consumer group is from the latest message available in a partition on the Kafka broker. It is calculated as the difference between the broker's log-end-offset (the offset of the last message committed to the cluster) and the consumer's last committed offset for that partition. Monitoring lag is essential to ensure consumers are keeping pace with the data stream and to identify any potential processing delays or backlogs

image::m1/roundup-image.png[]



. Navigate to the https://amq-streams-console-{user_name}.{openshift_cluster_subdomain}/kafka[streams console, window="console"] > topics > consumer groups > demo-cg and expand consumer cg-c1 we started previously. 

. As the producer continuously keeps churning out messages, observe the lag, committed offset and end offset keep changing for each consumer as shown below. The lag is basically End Offset - Committed Offset. Feel free to refresh the page if you don't see the values changing for the lag, committed offset and end offset.
+
image::m1/lag-offset.png[]


. If there are multiple consumers, the Consumer group demo-cg also maintains an overall lag for the entire group which is the sum of the lag for each consumer as shown below.
+
image::m1/group-lag.png[]

. Now go ahead and stop the producer in the *upper terminal* (Ctrl+C) and also stop all the consumers in the *lower terminal* by pressing enter.


=== Summary
. A consumer group is a coordinated set of consumers that share a topic’s partitions.

. At most one consumer per partition per group: if your topic has 3 partitions, up to 3 consumers in the same group can read in parallel; a 4th will sit idle.

. Kafka tracks the group’s offset per partition (so the group, as a whole, has a reading position).

. A different group has its own offsets, so it can re-read the entire topic independently.

=== Clean up
* Type *ctrl+c* in the *upper terminal* to stop the producer.
* Hit enter in the *lower terminal* to stop all the remaining consumers.

=== Up Next
In the next section we will learn about Topic Replication and Fault Tolerance
