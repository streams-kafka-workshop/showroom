:imagesdir: ../../assets/images
include::../style.adoc[]

== Module 3: Simplify and secure traffic management with {rhcl}

Now that the Platform Engineer has made the Gateway available, Developers/App owners can now onboard their application/service endpoints to be available for secure access. 

== Activity: Developer workflow

In this section, you will perform the role of a developer. As self-service, create policies based on your application's needs to protect the core services' endpoints.

== Test access to the Travelz Web Application

. The sample Travelz web app has been deployed in OpenShift as part of the workshop setup.
. Access this  by clicking https://travels-blue-ui-travel-web.{ocp_cluster_openshift_cluster_ingress_domain}/[here^, console="access Web app"]
. You should see a 404 error status code. This is because the Travels core services endpoint hasn't been exposed using an HTTPRoute to make it available to other applications/systems.
+
image:m3/partner-blue-404.png[] 

== Set up HTTPRoute for Travels service endpoint

. Click the *(+)* button on the top navigation bar of {ocp_cluster_openshift_cluster_console_url}[OpenShift Console^, window="console"] to create a new HTTPRoute.
. In the YAML editor, copy the following *HTTPRoute* CR.
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: travel-agency
  namespace: travel-agency
  labels:
    deployment: travels-v1
    service: travels
spec:
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: prod-web
      namespace: ingress-gateway
  hostnames:
    - api.travels.{ocp_cluster_workshop_main_domain}
  rules:
    - backendRefs:
        - group: ''
          kind: Service
          name: travels
          namespace: travel-agency
          port: 8000
          weight: 1
      matches:
        - path:
            type: PathPrefix
            value: /
----

== Test Web App again after HTTPRoute is set up

. Refresh the Web application or access it from https://travels-blue-ui-travel-web.{ocp_cluster_openshift_cluster_ingress_domain}/[here^, console="access Web app"]. You should see a *403 - Forbidden* error
+
image:m3/partner-blue-403.png[] 

. This is because while you have the HTTPRoute now, the original deny-all default policy kicks in and doesn't allow any requests to made. We have a zero-trust auth in place!!
. You can validate this by accessing {rhcl}'s {ocp_cluster_openshift_cluster_console_url}/kuadrant/policy-topology[Policy Topology^, window="console"].}. You will notice that the `travel-agency` HTTPRoute also inherits the Gateway's policies (just like the `echo-api` HTTRoute)
+
image:m3/travel-404-policy-topology.png[] 

== Setup Authpolicy

. Next, create an AuthPolicy targeting the HTTPRoute based on your application's needs.
. Click the *(+)* button on the top navigation bar of {ocp_cluster_openshift_cluster_console_url}[OpenShift Console^, window="console"] to create a new AuthPolicy for the HTTPRoute.
. In the YAML editor, copy the following CRs, which creates an AuthPolicy along with the API Keys needed 
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: kuadrant.io/v1
kind: AuthPolicy
metadata:
  name: travel-agency-authpolicy
  namespace: travel-agency
spec:
  defaults:
    rules:
      authentication:
        api-key-authn:
          apiKey:
            allNamespaces: false
            selector:
              matchLabels:
                app: partner
          credentials:
            queryString:
              name: APIKEY
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: travel-agency

---
apiVersion: v1
kind: Secret
metadata:
  name: apikey-blue
  namespace: kuadrant-system
  labels:
    authorino.kuadrant.io/managed-by: authorino
    app: partner
stringData:
  api_key: blue
type: Opaque
----
. Click *Create* to create these resources
image:m3/auth-apikey-created.png[width=80%] 
+
NOTE: For the sake of the workshop, we have chosen to authenticate using a simplistic API Key. In the real world, consider using a JWT/OAuth access token to authenticate the requests.
.  Access {rhcl}'s {ocp_cluster_openshift_cluster_console_url}/kuadrant/policy-topology[Policy Topology^, window="console"] once more. 
.. You will notice that the `travel-agency` HTTPRoute is now impacted by its own AuthPolicy.
.. You will also notice (in your browser) that the `prod-web` Gateway's RateLimitPolicy still affects the `travel-agency` HTTPRoute.
+
image:m3/travel-ap-topology.png[width=80%] 

== Test Web App again (after HTTPRoute and AuthPolicy are set up)

. Refresh the partner portal one more time. You should now see a `API Call is successful` message.
+
image:m3/webapp-success.png[] 
. Choose a City, a From, and a To date, and click the *Find details* button
+
image:m3/webapp-see-details.png[] 

==  Test the default RateLimit Policy
. Clicking the  *Find details* button more than 5 times.
. Expect to see a 429 error:
+
image:m3/partner-blue-429.png[]
. This is because of the super low rate limit configured for the Gateway.
. Since there is no RateLimit Policy for the Travels HTTPRoute, the Gateway's RateLimit Policy is applied to the HTTPRoute as well.


== Create a new RateLimit Policy which overrides the default gateway policy

. Click the *(+)* button on the top navigation bar of {ocp_cluster_openshift_cluster_console_url}[OpenShift Console^, window="console"] to create a new AuthPolicy for the HTTPRoute.
. In the YAML editor, copy the following CRs, which creates AuthPolicy along with the API Keys neede.d 
+
[source,sh,role="execute",subs=attributes+]
----
apiVersion: kuadrant.io/v1
kind: RateLimitPolicy
metadata:
  name: ratelimit-policy-travels
  namespace: travel-agency
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: travel-agency
  limits:
    "per-user":
      rates:
        - limit: 20
          window: 10s
      counters:
        - expression: auth.identity.userid
----
. Click *Create*.
image:m3/httproute-rlp-created.png[] 


== Test again (after HTTPRoute, AuthPolicy, and RateLimitPolicy are set up)

. Try accessing the details again by clicking the *Find details* button.
+
image:m3/webapp-see-details.png[] 
. You should now be able to retrieve details without a `429 - Too Many Requests` error for up to 20 requests in a duration of 10 seconds.
.  You will notice in the  {rhcl}'s {ocp_cluster_openshift_cluster_console_url}/kuadrant/policy-topology[Policy Topology^, window="console"].} that  the `travel-agency` HTTPRoute has its own Auth and RateLimit policies which effectively override the zero-trust and super low-limits setup on the Gateway.
+
image:m3/travel-final-topo.png[width=80%] 

== Summary

. In this section, you played the role of a Developer and created a `travel-agency` HTTPRoute for the core services so that this can be accessed by the partner portal securely. You applied the right Auth and Rate Limit policies to the HTTPRoute thereby customising this to your specific needs in a self-service manner
. In the next section, you will be introduced to observability and monitoring.
